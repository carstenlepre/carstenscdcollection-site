<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carsten's CD Collection</title>
<!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-6JVTD474KV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-6JVTD474KV');
  </script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Carsten's CD Collection Radio</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bluu+2:wght@700&display=swap');

  body {
    margin: 0;
    font-family: 'Bluu 2', 'Poppins', sans-serif;
    background: linear-gradient(135deg, #496972, #b07ea6);
    color: #eee;
    text-align: center;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding: 2rem 1rem;
    overflow-x: hidden;
  }

  #logo {
    max-width: 180px;
    margin: 0 auto 1rem auto;
    filter: drop-shadow(3px 3px 6px rgba(0,0,0,0.9));
    user-select: none;
  }

  h1 {
    font-weight: 700;
    font-size: 3rem;
    margin: 0.2em 0 0.1em 0;
    letter-spacing: 0.06em;
    user-select: none;
    text-shadow: 3px 3px 5px rgba(0,0,0,0.7);
  }

  #slogan {
    font-weight: 500;
    font-size: 1.2rem;
    margin-bottom: 1.5rem;
    color: #d6c1d9;
    user-select: none;
  }

  nav {
    margin-bottom: 2rem;
    display: flex;
    justify-content: center;
    flex-wrap: wrap; /* Allow wrapping on smaller screens */
    gap: 0.6rem; /* space between buttons */
  }

  .nav-btn {
    background: linear-gradient(45deg, #8e7db4, #b07ea6);
    border: none;
    color: #eee;
    font-weight: 700;
    padding: 0.5rem 1.1rem;
    border-radius: 14px;
    cursor: pointer;
    box-shadow: 0 0 6px #b07ea6;
    transition: all 0.3s ease;
    user-select: none;
    font-size: 1rem;
    letter-spacing: 1.2px;
    white-space: nowrap; /* prevent text wrap inside button */
  }
  .nav-btn:hover, .nav-btn:focus {
    box-shadow:
      0 0 8px #d3a7e0,
      0 0 20px #b07ea6,
      0 0 28px #d3a7e0,
      0 0 40px #b07ea6;
    transform: scale(1.1);
    outline: none;
  }

  #content {
    flex-grow: 1;
    max-width: 440px;
    margin: 0 auto;
    text-align: left;
    color: #dce6eb;
  }

  section {
    display: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  section.active {
    display: block;
    opacity: 1;
  }

  /* Home */
  #home .now-playing-title,
  #listen .now-playing-title {
    font-size: 1.3rem;
    margin-bottom: 0.6rem;
    color: #dbe9f4;
    text-shadow: 1.5px 1.5px 3px #204040;
    user-select: none;
  }
  #home .recently-played-list,
  #listen .recently-played-list {
    font-size: 0.9rem;
    background: rgba(0,0,0,0.15);
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.6);
    padding: 0.5rem 1rem;
    max-height: 8rem;
    overflow-y: auto;
    list-style: none;
    user-select: none;
  }
  .recently-played-list li {
    padding: 0.25em 0;
    border-bottom: 1px solid rgba(255,255,255,0.15);
  }
  .recently-played-list li:last-child {
    border-bottom: none;
  }
  /* Center cover art on home page */
  #home #home-cover-art {
    width: 140px;
    height: 140px;
    border-radius: 12px;
    box-shadow: 0 8px 22px rgba(0,0,0,0.7);
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.5s ease;
    margin-bottom: 1rem;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }

  /* Listen Now */
  #listen audio {
    width: 100%;
    border-radius: 14px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.7), inset 0 0 15px rgba(73,105,114,0.6);
    margin-bottom: 1.2rem;
  }
  #listen #listen-cover-art {
    width: 280px;
    height: 280px;
    border-radius: 16px;
    box-shadow: 0 8px 26px rgba(0,0,0,0.85);
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.5s ease;
    margin-bottom: 1.2rem;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }
  #listen .recently-played-list {
    max-height: 9rem;
  }
  #listen .now-playing-title {
    font-size: 1.7rem;
    font-weight: 700;
    margin-bottom: 1rem;
    text-align: center;
    letter-spacing: 0.03em;
  }

  /* Request/Call */
  #requests h2,
  #about h2 {
    font-size: 2rem;
    color: #e4d7f5;
    text-shadow: 0 0 8px #856b9d;
    margin-bottom: 1rem;
  }
  #requests p, #about p {
    line-height: 1.5;
    margin-bottom: 1rem;
    color: #dcdde1;
  }
  #requests a, #about a {
    color: #a1cee8;
    font-weight: 600;
    text-decoration: none;
  }
  #requests a:hover, #about a:hover {
    text-decoration: underline;
  }
  #requests .note {
    font-size: 0.85rem;
    font-style: italic;
    color: #c8c8c8;
    margin-top: 0.6rem;
    max-width: 400px;
  }

  /* Responsive */
  @media (max-width: 480px) {
    h1 {
      font-size: 2.2rem;
    }
    #listen #listen-cover-art {
      width: 220px;
      height: 220px;
    }
    #home #home-cover-art {
      width: 110px;
      height: 110px;
    }
    .nav-btn {
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
      margin: 0;
    }
    nav {
      justify-content: center;
      gap: 0.4rem;
      overflow-x: visible;
      flex-wrap: wrap; /* allow buttons to wrap */
    }
  }
</style>
</head>
<body>

  <img id="logo" src="https://i.imgur.com/VzBkTa5.png" alt="Carsten's CD Collection Logo" />
  <h1>Carsten's CD Collection Radio</h1>
  <div id="slogan">Streaming hand-picked tracks from a vast CD library â€“ live commentary included</div>

  <nav>
    <button class="nav-btn" data-target="home">Home</button>
    <button class="nav-btn" data-target="listen">Listen Now</button>
    <button class="nav-btn" data-target="requests">Request/Call</button>
    <button class="nav-btn" data-target="about">About</button>
    <button class="nav-btn" data-target="schedule">Schedule</button>
  </nav>

  <main id="content">
    <section id="home" class="active" aria-label="Home section">
      <img id="home-cover-art" alt="Album cover art" />
      <div class="now-playing-title">Loading now playing...</div>
      <ul class="recently-played-list"></ul>
    </section>

    <section id="listen" aria-label="Listen Now section">
      <audio id="audio-player" controls autoplay>
        <source src="https://eagle.streemlion.com/proxy/carsten?mp=/stream" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>

      <img id="listen-cover-art" alt="Album cover art" />

      <div class="now-playing-title">
        Loading now playing...
      </div>

      <ul class="recently-played-list"></ul>
    </section>

    <section id="requests" aria-label="Requests and Call section">
      <h2>Send in your requests or song submissions below!</h2>
      <p>ðŸ“ž Call or text: <strong>(908) 605-0391</strong> â€” request songs or chat on air!</p>
      <p>Email: <a href="mailto:carstenscdcollection@gmail.com">carstenscdcollection@gmail.com</a></p>
      <p>Instagram: <a href="https://instagram.com/carstenscdradio" target="_blank" rel="noopener">@carstenscdradio</a></p>
      <p>Besides requests for your favorite songs, I also accept original song submissions! Email or DM the file for airtime.</p>
      <p class="note">*Please note that my library of songs is based on my actual CD collectionâ€”I might not have what you request.*</p>
    </section>

    <section id="about" aria-label="About section">
      <h2>About Carsten's CD Collection Radio</h2>
      <p>Hello! My name is Carsten Lepre, and I am a 16 year old music lover and CD collector. Carstenâ€™s CD Collection Radio is my project to deliver my favorite songs directly to the listener, while honing my love for podcasting with live commentary and deep dives.</p>
      <p>My music taste is eclectic, because when your main source of listening is thrifted/record store bought CDs, you never know what youâ€™ll pick up. However, youâ€™ll hear a lot of John Mayer, Coldplay, Beatles, Tame Impala, Jack Johnson, and so much more. The best part about music straight from a vast CD collection is that itâ€™s incredibly diverse!</p>
      <p>Stick with me for fun segments like full album listen-throughs or a focus on one specific artist for a few songs with intermittent commentary and anecdotes.</p>
      <p>For scheduling, youâ€™ll find the dates and times that the station is live on the stationâ€™s Instagram page: <a href="https://instagram.com/carstenscdradio" target="_blank" rel="noopener">@carstenscdradio</a>, but you can also follow my main page <a href="https://instagram.com/carstenlepre8" target="_blank" rel="noopener">@carstenlepre8</a>.</p>
      <p>Visit the Request/Call page on the website for info about submitting your own original music or sending in your favorite song requests. There you will find various methods to reach me/the station. Hope you enjoy!</p>

     <div style="text-align: center; margin-top: 2em;">
  <p>Help keep the station up and running :)</p>
  <a href="https://buymeacoffee.com/carstenscdradio" target="_blank" rel="noopener noreferrer">
    <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 45px;">
  </a>
</div>
    </section>

    <section id="schedule" aria-label="Schedule section" style="display:none; opacity:0; transition: opacity 0.3s ease;">
  <h2 style="
    font-size: 2.5rem; 
    color: #e4d7f5; 
    text-shadow: 0 0 12px #856b9d; 
    margin-bottom: 1rem; 
    text-align: center;
  ">
    Summer Schedule
  </h2>

  <div style="text-align: center; margin-bottom: 2rem; font-size: 1.2rem; color: #dcdde1; line-height: 1.6;">
    <p><strong>Tuesdays</strong><br>7â€“10pm EST</p>
    <p><strong>Thursdays</strong><br>7â€“10pm EST</p>
    <p><strong>Saturdays</strong><br>7â€“10pm EST</p>
  </div>

  <h2 style="
    font-size: 2rem; 
    color: #e4d7f5; 
    text-shadow: 0 0 12px #856b9d; 
    margin-bottom: 1rem; 
    text-align: center;
  ">
    Upcoming Events
  </h2>

  <p style="text-align: center; font-size: 1.1rem; color: #dcdde1; margin-bottom: 2rem;">
    <strong>Currents by Tame Impala 10th Anniversary Listening Party</strong><br>
    Thursday, July 24th at 7pm EST
  </p>

  <p class="note" style="text-align: center; font-size: 0.85rem; font-style: italic; color: #c8c8c8; margin-top: 2rem;">
    *please note that there will be no broadcasts from Saturday July 26th to August 4th. Broadcasting will resume Tuesday, August 5th*
  </p>
</section>
  </main>

<script>
  // Page navigation with fade
  const buttons = document.querySelectorAll('nav .nav-btn');
  const sections = document.querySelectorAll('main > section');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-target');
      sections.forEach(sec => {
        if (sec.id === target) {
          sec.classList.add('active');
          sec.style.display = 'block';
          setTimeout(() => sec.style.opacity = '1', 10);
        } else {
          sec.style.opacity = '0';
          setTimeout(() => sec.classList.remove('active'), 300);
          setTimeout(() => sec.style.display = 'none', 300);
        }
      });
    });
  });

  // Elements for metadata updates
  const nowPlayingElems = document.querySelectorAll('.now-playing-title');
  const recentlyPlayedULs = document.querySelectorAll('.recently-played-list');
  const coverArtListen = document.getElementById('listen-cover-art');
  const coverArtHome = document.getElementById('home-cover-art');

  let recentTracks = [];
  let lastTrack = '';
  let updateTimeout;

  function cleanTrackTitle(title) {
    return title.replace(/\s*\(.*?\)|\s*\[.*?\]/g, '').trim();
  }



async function fetchCoverArt(track, artist) {
    const cleanTitle = cleanTrackTitle(track);
    let searchTerm = cleanTitle;

    // Add artist and/or album to the search term if available
    if (artist) {
        searchTerm += ` ${artist}`;
    }
    else {
        searchTerm += ' wigwamcenter';
    }

    const url = `https://itunes.apple.com/search?term=${encodeURIComponent(searchTerm)}&entity=song&limit=10`;  // Fetch multiple results

    try {
        const res = await fetch(url);
        const json = await res.json();

        if (json.resultCount > 0) {
            // Try to find the exact match based on title and artist
            const normalize = str =>
  cleanTrackTitle(str)
    .toLowerCase()
    .replace(/[^\w\s]/g, '') // remove punctuation
    .replace(/\s+/g, ' ')    // normalize spacing
    .trim();

const normalizedSearchTitle = normalize(track);
const normalizedSearchArtist = artist ? artist.toLowerCase() : null;

let bestMatch = null;
let bestScore = 0;

console.log(`ðŸŽ¯ [CoverArt] Matching "${normalizedSearchTitle}" ${normalizedSearchArtist ? `by "${normalizedSearchArtist}"` : ''}`);
console.log(`ðŸ“Š [CoverArt] Evaluating ${json.results.length} results:`);

json.results.forEach((result, index) => {
  const resultTitle = normalize(result.trackName);
  const resultArtist = result.artistName.toLowerCase();

let score = 0;

// Prioritize good title match
if (resultTitle === normalizedSearchTitle) {
  score += 5;
} else if (resultTitle.includes(normalizedSearchTitle) || normalizedSearchTitle.includes(resultTitle)) {
  score += 3;
}

// Prefer correct artist
if (normalizedSearchArtist && resultArtist.includes(normalizedSearchArtist)) {
  score += 2;
}

// Penalize albums with junk keywords
const badAlbumKeywords = [
  'greatest hits', 'deluxe', 'remaster', 'tribute',
  'karaoke', 'single', 'soundtrack', 'voice performance'
];
const albumName = result.collectionName.toLowerCase();
if (badAlbumKeywords.some(keyword => albumName.includes(keyword))) {
  score -= 2;
}

  console.log(`  [${index + 1}] "${result.trackName}" by "${result.artistName}"`);
  console.log(`       â†’ Normalized title: "${resultTitle}"`);
  console.log(`       â†’ Normalized artist: "${resultArtist}"`);
  console.log(`       â†’ Match score: ${score}`);

  if (score > bestScore) {
    bestScore = score;
    bestMatch = result;
  }
});

if (bestMatch) {
  console.log(`âœ… [CoverArt] Selected: "${bestMatch.trackName}" by "${bestMatch.artistName}" (score: ${bestScore})`);
  return bestMatch.artworkUrl100.replace('100x100bb.jpg', '300x300bb.jpg');
}

            // If no exact match, return a generic image
            return 'https://i.imgur.com/SKEYAYe.png';  // Generic placeholder image
        }

        return 'https://i.imgur.com/SKEYAYe.png';  // Generic placeholder image if no results
    } catch (e) {
        console.warn('Cover art fetch failed:', e);
        return 'https://i.imgur.com/SKEYAYe.png';  // Return generic image on error
    }
}

  async function updateMetadata(data) {
    const rawTitle = data.nowPlaying || '';

    if (!rawTitle || rawTitle.toLowerCase() === 'no track info') {
      const offlineMsg = "The station is not live right now! Check @carstenscdradio on Instagram for updates and scheduling.";
      nowPlayingElems.forEach(el => el.textContent = offlineMsg);
      if (coverArtListen) coverArtListen.style.opacity = 0;
      if (coverArtHome) coverArtHome.style.opacity = 0;
      recentlyPlayedULs.forEach(ul => ul.innerHTML = '');
      return;
    }

    if (rawTitle === lastTrack) return;
    let firstLoad = lastTrack === '';
    lastTrack = rawTitle;

    let artist = null;
    let title = rawTitle;
    if (rawTitle.includes(' - ')) {
      [artist, title] = rawTitle.split(' - ').map(s => s.trim());
    }

    const nowPlayingStr = `Now Playing: ${artist} â€” ${title}`;

    if (!recentTracks.includes(rawTitle)) {
      recentTracks.unshift(rawTitle);
      if (recentTracks.length > 5) recentTracks.pop();
    }

    nowPlayingElems.forEach(el => el.textContent = nowPlayingStr);

    recentlyPlayedULs.forEach(ul => {
      ul.innerHTML = '';
      recentTracks.forEach(track => {
        const li = document.createElement('li');
        li.textContent = track;
        ul.appendChild(li);
      });
    });

    const coverUrl = await fetchCoverArt(title, artist);
    if (coverUrl) {
      if (firstLoad) {
        if (coverArtListen) {
          coverArtListen.src = coverUrl;
          coverArtListen.style.opacity = '1';
        }
        if (coverArtHome) {
          coverArtHome.src = coverUrl;
          coverArtHome.style.opacity = '1';
        }
      }
      if (updateTimeout) clearTimeout(updateTimeout);
      updateTimeout = setTimeout(() => {
        if (coverArtListen) {
          coverArtListen.src = coverUrl;
          coverArtListen.style.opacity = '1';
        }
        if (coverArtHome) {
          coverArtHome.src = coverUrl;
          coverArtHome.style.opacity = '1';
        }
      }, 4000); // 4 second delay for future updates
    } else {
      if (coverArtListen) coverArtListen.style.opacity = 0;
      if (coverArtHome) coverArtHome.style.opacity = 0;
    }
  }

  async function fetchMetadata() {
    try {
      const res = await fetch('https://metadata-proxy-git-main-carsten-lepres-projects.vercel.app/api/metadata');
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

      const data = await res.json();
      await updateMetadata(data);
    } catch (error) {
      const offlineMsg = "The station is not live right now! Check @carstenscdradio on Instagram for updates and scheduling.";
      nowPlayingElems.forEach(el => el.textContent = offlineMsg);
      if (coverArtListen) coverArtListen.style.opacity = 0;
      if (coverArtHome) coverArtHome.style.opacity = 0;
      recentlyPlayedULs.forEach(ul => ul.innerHTML = '');
      console.error('Fetch metadata error:', error);
    }
  }

  fetchMetadata();
  setInterval(fetchMetadata, 15000);
</script>

</body>
</html>

